{% extends 'base.html' %}
{% block contentmannigemport %}
{% load static %}
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="{% static 'AppOfDocuments/css/export.css' %}" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø±Ø¯</title>
</head>
<body>

  <div class="main-box">
    <div class="section-header">
      Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    </div>
    <div class="doc-count">
      Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©: <span id="docCount">{{ imports|length }}</span>
    </div>

    <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø§Ù„Ø¬Ù‡Ø©ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®" id="searchInput" onkeyup="filterTable()">

    <table id="documentsTable" border="1" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Ø§Ù„Ø±Ù‚Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø¬Ù‡Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for import in imports %}
          <tr>
            <td>{{ import.id }}</td>
            <td>{{ import.employee.username }}</td>
            <td>{{ import.document_title }}</td>
            <td>{{ import.sender }}</td>
            <td>{{ import.import_date }}</td>
            <td>{{ import.notes }}</td>
            <td>
              {% if import.import_image %}
                  <a href="{% url 'view_import_image' import.id %}" target="_blank">Ø¹Ø±Ø¶</a>
              {% else %}
                Ù„Ø§ ÙŠÙˆØ¬Ø¯
              {% endif %}
            </td>
            <td>
              <button onclick="printImportFromRow(this)">ğŸ–¨ï¸</button>
              <button onclick="window.location.href='/documents/edite_import/{{ import.id }}/'">âœï¸</button>
              <button onclick="deleteImport('{{ import.id }}')">ğŸ—‘ï¸</button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
function filterTable() {
  const input = document.getElementById('searchInput');
  const filter = input.value.toLowerCase();
  const table = document.getElementById('documentsTable');
  const trs = table.tBodies[0].getElementsByTagName('tr');

  for (let i = 0; i < trs.length; i++) {
    const tr = trs[i];
    const text = tr.textContent.toLowerCase();
    tr.style.display = text.includes(filter) ? '' : 'none';
  }
}

// CSRF token Ù…Ù† Ù‚Ø§Ù„Ø¨ Django (ØªØ£ÙƒØ¯ Ø£Ù† ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡)
const csrftoken = '{{ csrf_token }}';
document.cookie = "csrftoken={{ csrf_token }}";

function deleteImport(importId) {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
        fetch(`/documents/delete_import/${importId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.");
            }
        });
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            if (cookie.trim().startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.trim().substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function printImportFromRow(button) {
  const row = button.closest("tr");
  const link = row.querySelector("td:nth-child(7) a");

  if (link && link.href) {
    const printWindow = window.open("", "_blank");

    printWindow.document.write(`
      <html dir="rtl">
        <head>
          <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</title>
          <style>
            body { text-align: center; margin: 0; padding: 0; }
            img { max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img id="printImage" src="${link.href}">
        </body>
      </html>
    `);
    printWindow.document.close();

    printWindow.onload = function () {
      const image = printWindow.document.getElementById("printImage");
      if (image.complete) {
        printWindow.focus();
        printWindow.print();
      } else {
        image.onload = function () {
          printWindow.focus();
          printWindow.print();
        };
      }
    };

    printWindow.onafterprint = function () {
      printWindow.close();
    };
  } else {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©.");
  }
}

</script>

</body>
</html>
{% endblock contentmannigemport %}
