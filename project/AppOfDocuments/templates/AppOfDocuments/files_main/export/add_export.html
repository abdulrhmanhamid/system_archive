{% extends 'base.html'%} 
{% block add_exports%} 
{% load static %}

<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'AppOfDocuments/css/export.css' %}" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
<main class="content">
  <div class="form-container">
    <h2 class="form-title">إضافة الصادر</h2>

    <div class="form-right">
      <div class="form-group">
        <input id="titleInput" class="input-field" placeholder="عنوان الاطار" oninput="filterFiles(this.value)">
        <button type="button" onclick="fetchWordImage()" style="margin-left: 10px;">جلب</button>   </div>
     <div id="dropdownList" class="dropdown-list"></div>
      <div class="form-group">
        <input type="text" class="input-field" placeholder="الجهة المرسلة">
      </div>

      <div class="form-group">
        <input type="date" class="input-field" placeholder="تاريخ التسليم">
      </div>

      <div class="form-group">
        <textarea class="input-field" rows="4" placeholder="ملاحظات"></textarea>
      </div>

      <div class="upload-buttons">
        <!-- <button class="upload-btn" onclick="printDocument()">
          <i class="fas fa-scanner"></i> طباعة
        </button> -->
        <button class="upload-btn" onclick="uploadFile()">
          <i class="fas fa-file-upload"></i> رفع وثيقة
        </button>
      </div>

      <div class="stamp-view-buttons">
        <button class="upload-btn stamp-btn" onclick="applyStamp()">
          <i class="fas fa-stamp"></i> ختم الصادر
        </button>
        <button class="upload-btn stamp-btn" onclick="window.location.href='/documents/manage_export/'">
          عرض
        </button>
      </div>

      <button class="save-btn" onclick="saveImage()">حفظ</button>
    </div>

    <div class="form-left">
      <div class="image-upload" id="imageUpload">
        <canvas id="canvas" style="max-width:100%; max-height:100%;"></canvas>
      </div>
    </div>
  </div>
</main>

<script>

{% if stamp_warning %}
  <div style="color: red; font-weight: bold; margin: 10px;">
    {{ stamp_warning }}
  </div>
{% endif %}
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentImage = new Image();

function uploadFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/png, image/jpeg';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        currentImage = new Image();
        currentImage.onload = function() {
          canvas.width = currentImage.width;
          canvas.height = currentImage.height;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(currentImage, 0, 0);
        };
        currentImage.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };
  input.click();
}


function applyStamp() {
  if (!currentImage.src) {
    alert("الرجاء رفع صورة أولاً.");
    return;
  }

  const stampImg = new Image();
  stampImg.src = "{% static 'AppOfDocuments/images/stamp.png' %}"; // مسار صورة الختم

  stampImg.onload = function () {
    // إعادة رسم الصورة الأصلية لتحديث السياق
    ctx.clearRect(0, 0, canvas.width+2, canvas.height+2);
    ctx.drawImage(currentImage, 0, 0);

    const stampWidth = 100;
    const stampHeight = 100;
    const marginTop = 70; // تقريبًا 1 سم (يعتمد على دقة الشاشة)
    const marginLeft = 100;

    // رسم الختم بشفافية
    ctx.globalAlpha = 0.6;
    ctx.drawImage(stampImg, marginLeft, marginTop, stampWidth, stampHeight);
    ctx.globalAlpha = 1.0;

    // رسم التاريخ أسفل الختم
    const dateText = new Date().toLocaleDateString('EG');
    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
    ctx.font = '16px Arial';
    //ctx.fillRect(marginLeft, marginTop + stampHeight + 5, 90, 25); // خلفية التاريخ
    ctx.fillStyle = 'bl';
    ctx.fillText(dateText, marginLeft +70, marginTop + stampHeight + 10);
  };
}


function saveImage() {
  const imageData = canvas.toDataURL('image/png');
  const title = document.getElementById('titleInput').value;
  const recipient = document.querySelector("input[placeholder='الجهة المرسلة']").value;
  const date = document.querySelector("input[type='date']").value;
  const notes = document.querySelector("textarea").value;

  if (!title || !recipient || !date || !imageData) {
    alert("الرجاء تعبئة جميع الحقول وإرفاق الصورة قبل الحفظ.");
    return;
  }

  fetch('/documents/save_export/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: JSON.stringify({
      document_title: title,
      recipient: recipient,
      export_date: date,
      notes: notes,
      export_image: imageData,
    })
  })
  .then(response => {
    if (response.ok) {
      alert("تم الحفظ بنجاح!");

      // ✅ تنظيف النموذج
      document.getElementById('titleInput').value = '';
      document.querySelector("input[placeholder='الجهة المرسلة']").value = '';
      document.querySelector("input[type='date']").value = '';
      document.querySelector("textarea").value = '';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      currentImage = new Image();
    } else {
      alert("حدث خطأ أثناء الحفظ.");
    }
  });
}


function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const trimmed = cookie.trim();
      if (trimmed.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

let selectedTemplateId = null;

function filterFiles(keyword) {
  if (keyword.length < 1) {
    dropdownList.innerHTML = "";
    selectedTemplateId = null;
    return;
  }
  fetch(`/documents/search_templates/?q=${encodeURIComponent(keyword)}`)
    .then(response => response.json())
    .then(data => {
      dropdownList.innerHTML = "";
      data.forEach(item => {
        const div = document.createElement("div");
        div.textContent = item.document_title;
        div.style.cursor = "pointer";
        div.onclick = () => {
          selectedTemplateId = item.id;
          window.open(`/documents/download_word/${item.id}/`, '_blank');
          dropdownList.innerHTML = "";
          document.getElementById('titleInput').value = item.document_title;
        };
        dropdownList.appendChild(div);
      });
    });
}
function fetchWordImage() {
  const title = document.getElementById('titleInput').value.trim();
  if (!title) {
    alert('ادخل عنوان الإطار أولاً');
    return;
  }
  fetch(`/documents/get_word_image/?title=${encodeURIComponent(title)}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const image = new Image();
        image.onload = () => {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = image.width;
          canvas.height = image.height;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(image, 0, 0);
          
          // ✅ تحديث currentImage هنا حتى يتعرف عليه applyStamp()
          currentImage = new Image();
          currentImage.src = image.src;
        };
        image.src = data.image_url;
      } else {
        alert('خطأ: ' + data.error);
      }
    })
    .catch(err => {
      alert('حدث خطأ في جلب الصورة');
      console.error(err);
    });
}


</script>
</body>
{% endblock add_exports %}
