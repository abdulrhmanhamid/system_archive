{% extends 'base.html'%}
{% block manage_export %}
{% load static %}
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="{% static 'AppOfDocuments/css/export.css' %}" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

  <div class="main-box">
    <div class="section-header">
      عرض الصادر 
    </div>
    <div class="doc-count">
      <span id="docCount">عدد الوثائق الصادره : {{ exports|length }}</span>
    </div>

    <input type="text" class="search-input" placeholder="بحث من الموضوع، الجهة، التاريخ" id="searchInput" onkeyup="filterTable()">

    <table id="documentsTable" border="1" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>الرقم</th>
          <th>اسم المستخدم</th>
          <th>العنوان</th>
          <th>الجهة</th>
          <th>التاريخ</th>
          <th>الملاحظة</th>
          <th>الوثيقة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for export in exports %}
          <tr>
            <td>{{ export.id }}</td>
            <td>{{ export.employee.username }}</td>
            <td>{{ export.document_title }}</td>
            <td>{{ export.recipient }}</td>
            <td>{{ export.export_date }}</td>
            <td>{{ export.notes }}</td>
            <td>
              {% if export.export_image %}
                  <a href="{% url 'view_export_image' export.id %}" target="_blank">عرض</a>
              {% else %}
                لا يوجد
              {% endif %}
            </td>
            <td>
              <button onclick="printExportFromRow(this)">🖨️</button>
              <button onclick="window.location.href='/documents/edite_export/{{ export.id }}/'">✏️</button>
              <button onclick="deleteExport('{{ export.id }}')">🗑️</button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">لا توجد بيانات</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
function filterTable() {
  const input = document.getElementById('searchInput');
  const filter = input.value.toLowerCase();
  const table = document.getElementById('documentsTable');
  const trs = table.tBodies[0].getElementsByTagName('tr');

  for (let i = 0; i < trs.length; i++) {
    const tr = trs[i];
    const text = tr.textContent.toLowerCase();
    tr.style.display = text.includes(filter) ? '' : 'none';
  }
}

const csrftoken = '{{ csrf_token }}';

function deleteExport(exportId) {
  if (confirm("هل أنت متأكد من حذف هذه الوثيقة؟")) {
    fetch(`/documents/delete_export/${exportId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    })
    .then(response => {
      if (response.ok) {
        alert('تم الحذف بنجاح');
        location.reload();
      } else {
        alert('فشل الحذف');
      }
    });
  }
}

function printExportFromRow(button) {
  const row = button.closest("tr");
  const link = row.querySelector("td:nth-child(7) a");

  if (link && link.href) {
    const printWindow = window.open("", "_blank");

    printWindow.document.write(`
      <html dir="rtl">
        <head>
          <title>طباعة الوثيقة</title>
          <style>
            body { text-align: center; margin: 0; padding: 0; }
            img { max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img id="printImage" src="${link.href}">
        </body>
      </html>
    `);
    printWindow.document.close();

    // سيتم إغلاق النافذة تلقائيًا بعد الطباعة
    printWindow.onload = function () {
      const image = printWindow.document.getElementById("printImage");
      if (image.complete) {
        printWindow.focus();
        printWindow.print();
      } else {
        image.onload = function () {
          printWindow.focus();
          printWindow.print();
        };
      }
    };

    // بعد الطباعة أو الإلغاء، يتم إغلاق النافذة
    printWindow.onafterprint = function () {
      printWindow.close();
    };
  } else {
    alert("لا توجد صورة لهذه الوثيقة.");
  }
}


</script>


</body>
</html>
{% endblock %}
