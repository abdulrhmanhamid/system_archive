{% extends 'base.html'%}
{% block manage_export %}
{% load static %}
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="{% static 'AppOfDocuments/css/export.css' %}" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

  <div class="main-box">
    <div class="section-header">
      Ø¹Ø±Ø¶ Ø§Ù„ØµØ§Ø¯Ø± 
    </div>
    <div class="doc-count">
      <span id="docCount">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ØµØ§Ø¯Ø±Ù‡ : {{ exports|length }}</span>
    </div>

    <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø§Ù„Ø¬Ù‡Ø©ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®" id="searchInput" onkeyup="filterTable()">

    <table id="documentsTable" border="1" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Ø§Ù„Ø±Ù‚Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ø¬Ù‡Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for export in exports %}
          <tr>
            <td>{{ export.id }}</td>
            <td>{{ export.employee.username }}</td>
            <td>{{ export.document_title }}</td>
            <td>{{ export.recipient }}</td>
            <td>{{ export.export_date }}</td>
            <td>{{ export.notes }}</td>
            <td>
              {% if export.export_image %}
                  <a href="{% url 'view_export_image' export.id %}" target="_blank">Ø¹Ø±Ø¶</a>
              {% else %}
                Ù„Ø§ ÙŠÙˆØ¬Ø¯
              {% endif %}
            </td>
            <td>
              <button onclick="printExportFromRow(this)">ğŸ–¨ï¸</button>
              <button onclick="window.location.href='/documents/edite_export/{{ export.id }}/'">âœï¸</button>
              <button onclick="deleteExport('{{ export.id }}')">ğŸ—‘ï¸</button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
function filterTable() {
  const input = document.getElementById('searchInput');
  const filter = input.value.toLowerCase();
  const table = document.getElementById('documentsTable');
  const trs = table.tBodies[0].getElementsByTagName('tr');

  for (let i = 0; i < trs.length; i++) {
    const tr = trs[i];
    const text = tr.textContent.toLowerCase();
    tr.style.display = text.includes(filter) ? '' : 'none';
  }
}

const csrftoken = '{{ csrf_token }}';

function deleteExport(exportId) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŸ")) {
    fetch(`/documents/delete_export/${exportId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    })
    .then(response => {
      if (response.ok) {
        alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
        location.reload();
      } else {
        alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
      }
    });
  }
}

function printExportFromRow(button) {
  const row = button.closest("tr");
  const link = row.querySelector("td:nth-child(7) a");

  if (link && link.href) {
    const printWindow = window.open("", "_blank");

    printWindow.document.write(`
      <html dir="rtl">
        <head>
          <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</title>
          <style>
            body { text-align: center; margin: 0; padding: 0; }
            img { max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img id="printImage" src="${link.href}">
        </body>
      </html>
    `);
    printWindow.document.close();

    // Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    printWindow.onload = function () {
      const image = printWindow.document.getElementById("printImage");
      if (image.complete) {
        printWindow.focus();
        printWindow.print();
      } else {
        image.onload = function () {
          printWindow.focus();
          printWindow.print();
        };
      }
    };

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŒ ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    printWindow.onafterprint = function () {
      printWindow.close();
    };
  } else {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©.");
  }
}


</script>


</body>
</html>
{% endblock %}
