{% extends 'base.html'%}
{% block manage_fram_export%}
{% load static %}
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="{% static 'AppOfDocuments\css\fram_export.css' %}" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div class="main-box">
    <div class="section-header">
      عرض الاطارات 
    </div>
    <div class="doc-count">
      عدد الاطارات الجاهزة: <span id="docCount">{{ templates|length }}</span>
    </div>

    <input type="text" class="search-input" placeholder="بحث من الموضوع، الجهة، التاريخ" id="searchInput">

    <table>
      <thead>
        <tr>
          <th>الرقم</th>
          <th>اسم المستخدم</th>
          <th>العنوان</th>
          <th>التاريخ</th>
          <th>الملاحظة</th>
          <th>الاطار</th>
          <th>اختيار</th>
        </tr>
      </thead>
      <tbody id="documentsTable">
        {% for template in templates %}
        <tr>
          <td>{{ template.id }}</td>
          <td>{{ template.employee.username }}</td>
          <td>{{ template.document_title }}</td>
          <td>{{ template.date_time|date:"j" }}{{ template.date_time|date:"F" }}{{ template.date_time|date:"Y" }}</td>
          <td>{{ template.notes }}</td>
          <td> <a href="{% url 'open_word_template' template.id %}">فتح الإطار</a></td>
          <td class="radio-cell"><input type="radio" name="selectDoc" value="{{ template.id }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="buttons">
      <button onclick="deleteDocument()">🗑️ حذف</button>
    </div>
  </div>

  <script>
   // زر التعديل
  function editDocument() {
    const selected = document.querySelector('input[name="selectDoc"]:checked');
    if (selected) {
      const id = selected.value;
      window.location.href = `/documents/edit_frame_template/${id}/`;
    } else {
      alert("يرجى تحديد وثيقة للتعديل.");
    }
  }

  // زر الحذف
function deleteDocument() {
  const selected = document.querySelector('input[name="selectDoc"]:checked');
  if (selected) {
    const id = selected.value;

    if (confirm("هل أنت متأكد من حذف هذا الإطار؟")) {
      fetch(`/documents/delete_frame_template/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      })
      .then(response => {
        if (response.ok) {
          // حذف الصف من الجدول مباشرة بدون إعادة تحميل
          const row = selected.closest('tr');
          row.remove();

          // تحديث عدد الإطارات
          const countSpan = document.getElementById("docCount");
          const currentCount = parseInt(countSpan.textContent);
          countSpan.textContent = currentCount - 1;

        } else {
          alert("حدث خطأ أثناء الحذف.");
        }
      });
    }
  } else {
    alert("يرجى تحديد وثيقة للحذف.");
  }
}


  // تصفية الجدول عند الكتابة
  document.getElementById("searchInput").addEventListener("input", function () {
    const keyword = this.value.trim().toLowerCase();
    const rows = document.querySelectorAll("#documentsTable tr");

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      const rowText = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(" ");
      row.style.display = rowText.includes(keyword) ? "" : "none";
    });
  });

  // فتح الإطار بدون تغيير الصفحة (فقط إذا رغبت مستقبلاً)
  function openTemplate(templateId) {
    fetch(`/documents/open_template/${templateId}/`)
      .then(response => {
        if (!response.ok) {
          alert("فشل في فتح المستند.");
        }
      });
  }


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }


</script>



  
</body>
{% endblock manage_fram_export %}
