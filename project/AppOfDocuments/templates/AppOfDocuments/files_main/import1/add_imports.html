{% extends 'base.html'%}
 {% block contentadd_imports%}
 {% load static %}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الأرشيف</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background-color: #f0f2f5;
      direction: rtl;
    }
    
    .main-container {
      display: flex;
      min-height: calc(100vh - 70px);
    }
  
    .content {
      flex: 1;
      padding: 20px;
    }
    .form-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
    }
    .form-title {
      font-size: 20px;
      margin-bottom: 20px;
      color: #2c3e50;
      width: 100%;
      border: 2px solid #2980b9;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
    }
    .form-right, .form-left {
      flex: 1;
      min-width: 300px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .input-field {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .image-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      border-radius: 5px;
      min-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      position: relative;
    }
    .preview-btn {
      position: absolute;
      top: -40px;
      left: 0;
      background: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .upload-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

     .stamp-view-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .upload-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 15px;
      cursor: pointer;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;

    }
    .stamp-btn {
      background: #2ecc71;
       border: none;
      padding: 10px 10px;
      border-radius: 15px;
      cursor: pointer;
      width: 50%;
      left: 20px;
      font-size: 16px;
      justify-content: center;
      align-items: center;
       margin-bottom: 30px;
    
    }
    .save-btn {
      background: #2980b9;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 15px;
      cursor: pointer;
      width: 100%;
      font-size: 15px;
      transition: background 0.3s;
    }
    .stamp-btn:hover {
      background: #db5534;
    }
.save-btn:hover {
      background: #db5534;
    }
    .upload-btn:hover {
      background: #db5534;
    }

    @media (max-width: 768px) {
      .form-container {
        flex-direction: column;
      }
      .form-left, .form-right {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="header">
  </header>
    </aside>
    <main class="content">
      <div class="form-container">
        <h2 class="form-title">إضافة الوارد</h2>

        <div class="form-right">
          <div class="form-group">
            <input type="text" class="input-field" placeholder="العنوان">
          </div>
          <div class="form-group">
            <input type="text" class="input-field" placeholder="الجهة المرسلة">
          </div>
          <div class="form-group">
            <input type="date" class="input-field" placeholder="تاريخ التسليم">
          </div>
          <div class="form-group">
            <textarea class="input-field" rows="4" placeholder="ملاحظات"></textarea>
          </div>
          <div class="upload-buttons">
            <button class="upload-btn" onclick="scanDocument()">
              <i class="fas fa-scanner"></i>
              الماسح الضوئي
            </button>
            <button class="upload-btn" onclick="uploadFile()">
              <i class="fas fa-file-upload"></i>
              رفع وثيقة
            </button>
          </div>

        <div class="stamp-view-buttons">
          <button class="upload-btn stamp-btn" onclick="applyStamp()">
            <i class="fas fa-stamp"></i>
            ختم الوارد
          </button>
           <button class="upload-btn stamp-btn" onclick="window.location.href='/documents/manageimport/'">
             عرض
          </button>
        </div>

          <button class="save-btn" onclick="saveImage()">حفظ</button>
          
        </div>

        <div class="form-left">
          <div class="image-upload" id="imageUpload">
            <canvas id="canvas" style="max-width:100%; max-height:100%;"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const menuToggle = document.querySelector('.menu-toggle');
const sidebar = document.querySelector('.sidebar');
if (menuToggle) {
  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('hidden');
  });
}

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let currentImage = new Image();

    function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            currentImage.src = event.target.result;
            currentImage.onload = () => {
              canvas.width = currentImage.width;
              canvas.height = currentImage.height;
              ctx.drawImage(currentImage, 0, 0);
            };
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function scanDocument() {
      alert('سيتم الاتصال بالماسح الضوئي (هذه محاكاة - تتطلب API فعلية لتعمل)');
      // محاكاة صورة
      currentImage.src = 'https://via.placeholder.com/600x800';
      currentImage.onload = () => {
        canvas.width = currentImage.width;
        canvas.height = currentImage.height;
        ctx.drawImage(currentImage, 0, 0);
      };
    }

   function applyStamp() {


  // تحقق من وجود صورة
  if (!currentImage || !currentImage.src || currentImage.src === '') {
    alert('يرجى تحميل صورة أولاً قبل وضع الختم.');
    return;
  }

  if (!currentImage.src || !canvas || !ctx) return;

  // إعدادات الختم
  const stampText = 'وارد كلية الحاسبات والمعلوماتيه';
  const date = new Date().toLocaleDateString('ar-EG'); // التاريخ بالتنسيق العربي
  const padding = 20;
  const lineHeight = 40;

  ctx.font = 'bold 28px Arial';
  const textWidth = Math.max(ctx.measureText(stampText).width, ctx.measureText(date).width);

  const boxWidth = textWidth + padding * 2;
  const boxHeight = lineHeight * 2 + padding * 2;

  const boxX = (canvas.width - boxWidth) / 2;
  const boxY = (canvas.height - boxHeight) / 2;

  // رسم الخلفية الشفافة
  ctx.fillStyle = 'rgba(0, 128, 0, 0.25)';
  ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

  // رسم النص
  ctx.fillStyle = 'white';
  ctx.textAlign = 'center';

  ctx.fillText(stampText, canvas.width / 2, boxY + padding + lineHeight - 10);
  ctx.fillText(date, canvas.width / 2, boxY + padding + lineHeight * 2 - 10);
}
function saveImage() {
  if (!currentImage || !currentImage.src || currentImage.src === '') {
    alert('يرجى تحميل صورة أولاً قبل الحفظ.');
    return;
  }

  const imageData = canvas.toDataURL('image/png');
  const title = document.querySelector('input[placeholder="العنوان"]').value;
  const sender = document.querySelector('input[placeholder="الجهة المرسلة"]').value;
  const date = document.querySelector('input[placeholder="تاريخ التسليم"]').value;
  const notes = document.querySelector('textarea[placeholder="ملاحظات"]').value;

  // تحقق من الحقول المطلوبة
  if (!title || !sender || !date) {
    alert('الرجاء إدخال العنوان والجهة المرسلة وتاريخ التسليم');
    return;
  }

  fetch('/documents/save_import/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCSRFToken()
    },
    body: new URLSearchParams({
      'image': imageData,
      'title': title,
      'sender': sender,
      'date': new Date(date).toISOString().split('T')[0], // تأكد من التنسيق
      'notes': notes || ''
    })
  })
  .then(response => {
    if (!response.ok) throw new Error('Network error');
    return response.json();
  })
  .then(data => {
    console.log("Full response:", data); // لعرض التفاصيل في الكونسول
    if (data.status === 'success') {
      alert(`تم الحفظ بنجاح. رقم الوارد: ${data.id}`);
    } else {
      throw new Error(data.message || 'Unknown error');
    }
  })
  .catch(error => {
    console.error("Error details:", error);
    alert(`فشل الحفظ: ${error.message}`);
  });

}

//   function saveImage() {
//   if (!currentImage || !currentImage.src || currentImage.src === '') {
//     alert('يرجى تحميل صورة أولاً قبل الحفظ.');
//     return;
//   }

//   const imageData = canvas.toDataURL('image/png');

//   const title = document.querySelector('input[placeholder="العنوان"]').value;
//   const sender = document.querySelector('input[placeholder="الجهة المرسلة"]').value;
//   const date = document.querySelector('input[placeholder="تاريخ التسليم"]').value;
//   const notes = document.querySelector('textarea[placeholder="ملاحظات"]').value;

//   fetch('/documents/save_import/', {
//     method: 'POST',
//     headers: {
//       'Content-Type': 'application/json',
//       'X-CSRFToken': getCSRFToken()
//     },
//     body: JSON.stringify({
//       image: imageData,
//       title: title,
//       sender: sender,
//       date: date,
//       notes: notes
//     })
//   })
//   .then(response => {
//     if (response.ok) {
//       alert('تم الحفظ في قاعدة البيانات بنجاح.');
//     } else {
//       alert('فشل في الحفظ.');
//     }
//   });
// }

// جلب CSRF Token من الكوكيز
function getCSRFToken() {
  const name = 'csrftoken';
  const cookieValue = document.cookie.split('; ')
    .find(row => row.startsWith(name))
    ?.split('=')[1];
  return cookieValue || '';
}

  </script>
</body>
   

 {% endblock contentadd_imports%}
